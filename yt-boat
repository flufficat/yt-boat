#!/bin/bash

# Colour variables
green="\e[1;32m"
red="\e[1;31m"
yellow="\e[0;93m"
reset="\e[0m"

# Functions
PROGNAME="$(basename $0)"
error_exit()
{
echo -e "${yellow}${PROGNAME}: line $LINENO: Error: ${1:-"Unknown Error: Please submit an issue or contact me \
as this is probably an error with the code itself"}${reset}" 1>&2
}

queue_func()
{
cat /home/leon/.local/share/yt-boat/newsboat.queue
}

help_func()
{
echo -e "Usage:\nyt-boat [option]\noptions:\n\
-a --add [url]     Adds url to the queue\n\
-d --download      Downloads videos in the queue\n\
-c --clear         Clears the queue\n\
-q --queue         Shows the urls in the queue\n\
-u --update        Updates to the latest version of yt-boat\n\
-h --help          Shows this help message"
}

# Options
while test $# -gt 0; do
	case "$1" in
		-a|--add)
			shift
			if echo $1 >> $XDG_DATA_HOME/yt-boat/newsboat.queue; then
				echo -e "${green}Video added to queue${reset}"
			else
				error_exit
			fi
			shift
			;;
		-d|--download)
			shift
			if yt-dlp -a "$XDG_DATA_HOME/yt-boat/newsboat.queue"; then
				: > $XDG_DATA_HOME/yt-boat/newsboat.queue
				echo -e "${green}Videos downloaded${reset}"
			else
				error_exit "Probably invalid url"
			fi
			shift
			;;
		-c|-clear)
			shift
			if : > $XDG_DATA_HOME/yt-boat/newsboat.queue; then
				echo -e "${green}Queue cleared${reset}"
			else
				error_exit "Failed to clear queue"
			fi
			shift
			;;
		-q|--queue)
			shift
			if queue_func; then
				exit 0
			else
				error_exit "Failed to find queue"
			fi
			shift
			;;
		-h|--help)
			shift
			help_func
			shift
			;;
		-u|--update)
			shift
			if wget -o /tmp/log -P $XDG_DATA_HOME/yt-boat https://github.com/flufficat/yt-boat/releases/latest/download/yt-boat.tar.gz; then
				tar -C $XDG_DATA_HOME/yt-boat -xf $XDG_DATA_HOME/yt-boat/yt-boat.tar.gz && \
				chmod +x $XDG_DATA_HOME/yt-boat/yt-boat/yt-boat && \
				sudo mv /usr/local/bin/yt-boat /usr/local/bin/yt-boat_old && \
				sudo mv $XDG_DATA_HOME/yt-boat/yt-boat/yt-boat /usr/local/bin && \
				sudo rm -r $XDG_DATA_HOME/yt-boat/yt-boat && \
				sudo mv  $XDG_DATA_HOME/yt-boat/yt-boat.tar.gz $XDG_DATA_HOME/Trash/files && \
				if sudo mv /usr/local/bin/yt-boat_old $XDG_DATA_HOME/Trash/files; then
				echo -e "${green}Updated Sucessfully${reset}"
				else
				error_exit "Failed to update"
				fi
			else
				error_exit "Download failure"
			fi
			shift
			;;
        -hnb)
			shift
			clear && green="\e[1;32m" && echo -e "$(help_func)" && echo -e "${green}Press enter to go back to newsboat${reset}" && read && exit 0
			shift
			;;
			# look into cat and pipe to commands for getting info about feed
		-qnb)
			shift
			clear && echo -e "$(queue_func)" && echo -e "${green}Press enter to go back to newsboat${reset}" && read && exit 0
			shift
			;;
		*)
			shift
			error_exit "Not a valid option" && help_func
			shift
			;;

	esac
done
